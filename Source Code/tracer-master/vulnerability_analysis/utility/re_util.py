#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
-----------------------------------------
@Created: 2021/02/26
------------------------------------------
@Modify: 2021/02/26
------------------------------------------
@Description:

通用正则表达式识别~

"""
import os
import sys
import traceback
from typing import Union, List, Optional

import mysql.connector
from mysql.connector import MySQLConnection
from mysql.connector.pooling import PooledMySQLConnection

_PROJECT_NAME = 'VulnerabilityAnalysis'
_CURRENT_ABSPATH = os.path.abspath(__file__)
sys.path.insert(0, _CURRENT_ABSPATH[:_CURRENT_ABSPATH.find(_PROJECT_NAME) + len(_PROJECT_NAME) + 1])

import re

def extract_issuekey_from_url(url):
    # 'http://admin.fedoraproject.org/updates/EL-4/FEDORA-EPEL-2010-0163' -> EL-4/FEDORA-EPEL-2010-0163 -> FEDORA-EPEL-2010-0163, 限制num数>2
    issuekey_list = re.findall('((?:[A-Z]+-)*[A-Z]+-[0-9]{2,10}(?:-[0-9]{2,10})*)', url)
    return issuekey_list

def extract_issueid_from_url(url):
    """issueid是指纯数字"""
    # 'http://admin.fedoraproject.org/updates/EL-4/FEDORA-EPEL-2010-0163' -> EL-4/FEDORA-EPEL-2010-0163
    issueid_list = re.findall('[0-9]+', url)
    return issueid_list

def extract_commitid_in_svn_url(url):
    commitid_list = re.findall('[r]{,1}[0-9]{2,10}', url)
    if not commitid_list: return False
    else: return commitid_list[0]

def extract_commitid_in_commit_url(url):
    commitid_list = re.findall(r'(?![0-9]{6,40})(?![a-f]{6,40})[0-9a-f]{6,40}', url)  # 用于url内部识别
    if not commitid_list: return False
    else: return commitid_list[0]

def extract_issuekey_from_url_test():
    tc = 'http://admin.fedoraproject.org/updates/EL-4/FEDORA-EPEL-2010-0163'
    print(True if extract_issuekey_from_url(tc)==['FEDORA-EPEL-2010-0163'] else (False, tc) )

def extract_commitid_in_svn_url_test():
    tc = 'https://svn.apache.org/viewvc?view=rev&rev=1777472'
    print(True if extract_commitid_in_svn_url(tc) == '1777472' else (False, tc))
    tc = 'https://svn.apache.org/viewvc?view=rev&rev=r1777472'
    print(True if extract_commitid_in_svn_url(tc) == 'r1777472' else (False, tc))
    tc = 'https://svn.ruby-lang.org/repos/ruby/tags/v1_9_2_0/NEWS'
    print(True if not extract_commitid_in_svn_url(tc) else (False, tc))
    tc = 'https://svn.ruby-lang.org/repos/ruby/tags/v1_9_2_0/ChangeLog'
    print(True if not extract_commitid_in_svn_url(tc) else (False, tc))

def extract_commitid_in_commit_url_test():
    tc = 'https://github.com/vdiravka/drill/commits/DRILL-6739'
    res = extract_commitid_in_commit_url(tc)
    print(res)
    tc = 'https://github.com/openssl/openssl/commit/470990fee0182566d439ef7e82d1abf18b7085d7'
    res = extract_commitid_in_commit_url(tc)
    print(res)

if __name__ == '__main__':
    # extract_issuekey_from_url_test()
    # extract_commitid_in_svn_url_test()
    extract_commitid_in_commit_url_test()

#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
-----------------------------------------
@Created: 2020/12/18
------------------------------------------
@Modify: 2020/12/18
------------------------------------------
@Description:
"""
import os, sys, inspect
import requests

current_dir = os.path.dirname(os.path.abspath(inspect.getfile(inspect.currentframe())))
parent_dir = os.path.dirname(current_dir)
sys.path.insert(0, parent_dir)
sys.path.append('../')
sys.path.append('../..')
sys.path.append('../../..')

from vulnerability_analysis.utility.github_util import query_github_for_commits
from vulnerability_analysis.utility.parse_github_commit_util import get_commit_diff
from vulnerability_analysis.utility.parse_github_commit_util import get_function
from vulnerability_analysis.utility.crawler import crawl_util
from vulnerability_analysis.utility import re_util
# from vulnerability_analysis.utility.crawler import crawler_db as cdb


def parse_other_git_format(url):
    index = url.rfind("=")
    id = re_util.extract_commitid_in_commit_url( url=url )
    if not id: return False

    commit = query_github_for_commits(id)
    # print(commit)
    index = url.find("commit")
    diff_url=url[:index]+"commit/"+id+".diff"
    if commit == []:
        # check diff_url的格式有效性
        # 'https:http://kernel.suse.com/cgit/kernel/commit/95162b1101b3ea5db08ca6822ae9672717efec0.diff'
        diff_url = 'http' + diff_url.split('http')[-1]

        re = ''
        # # option2， 基于crawler DB
        # reponse_entity_from_DB = cdb.get(table='cve_ref', url=diff_url, crawler_method=cdb.S)
        # if reponse_entity_from_DB and reponse_entity_from_DB.raw:
        #     re = reponse_entity_from_DB.raw
        # # option1， 临时爬取
        status_code, raw = crawl_util.request_url_for_common_simplified( diff_url )
        re = raw
        file_list = re.split('\n')

        # # option1， 临时爬取
        # status_code, raw = crawl_util.request_url_for_common_simplified( diff_url )
        # re = raw
        # with open("temp.txt", "w") as f:
        #     f.write(re)
        # with open("temp.txt") as f:
        #     file_list = f.readlines()
        # os.remove("temp.txt")

        total_list = []
        new_file_list = []
        for line in file_list:
            # option 1
            # new_file_list.append(line[:-1])
            # option 2
            new_file_list.append(line[:-1])
        index_list = []
        for i in range(len(new_file_list)):
            if new_file_list[i].startswith("diff"):
                index_list.append(i)
        diff_list = []
        for i in range(len(index_list)):
            if i != len(index_list) - 1:
                diff_list.append(new_file_list[index_list[i] + 4:index_list[i + 1]])
            else:
                diff_list.append(new_file_list[index_list[i] + 4:])
        for i in range(len(index_list)):
            temp_dict = {}
            index=new_file_list[index_list[i]].rfind(" ")
            temp_dict["filename"] = new_file_list[index_list[i]][index+3:]
            # print(temp_dict["filename"])
            temp_dict["patch"] = "\n".join(diff_list[i])
            total_list.append(temp_dict)
        # print(diff_list)
        # print(total_list)
        function_list = []
        for item in total_list:
            function_list.append(get_function(item))
        # print(function_list)
        result_dict = {}
        for i in range(len(index_list)):
            file_name_with_path = new_file_list[index_list[i]][6:]
            file_name_index = file_name_with_path.rfind("/")
            file_name = file_name_with_path[file_name_index + 1:]
            result_dict[file_name_with_path] = {}
            result_dict[file_name_with_path]["filename"] = file_name
            result_dict[file_name_with_path]["diff"] = total_list[i]["patch"]
            result_dict[file_name_with_path]["function"] = function_list[i]
        final_dict = {"diff_source": url, url: result_dict, "patch_type": "diff file"}
        return final_dict
    else:
        return get_commit_diff(commit[0])


def main():
    # res = parse_other_git_format(
    #     "https://opendev.org/openstack/keystone/commit/?id=487c7276c7608fb11086b9875b0d7cc7cf594a5a")
    res = parse_other_git_format(
        url='https://git.openssl.org/gitweb/?p=openssl.git;a=commitdiff;h=36ca4ba6'
    )
    print(res)

def main_test():
    tc = 'https:http://kernel.suse.com/cgit/kernel/commit/95162b1101b3ea5db08ca6822ae9672717efec0.diff'
    res = parse_other_git_format(url=tc)
    print(res)


if __name__ == '__main__':
    main()
    # main_test()